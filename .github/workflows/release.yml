name: Build Release Asset & Checksums

on:
  workflow_dispatch:
    inputs:
      auto_bump:
        description: 'Automatically bump minor version (v5.x â†’ v5.(x+1)).'
        required: false
        default: 'true'
      tag:
        description: 'Tag name for release (e.g., v5.4). If auto_bump=true this is ignored.'
        required: false
  release:
    types: [created]

jobs:
  package:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Determine tag
        id: set_tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -eux
          if [ "${GITHUB_EVENT_NAME}" = "release" ]; then
            echo "Using tag from release event: ${{ github.event.release.tag_name }}"
            echo "tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
            exit 0
          fi

          # If auto_bump is true (default), compute next v5.x tag and push it
          AUTO_BUMP="${{ github.event.inputs.auto_bump }}"
          if [ -z "$AUTO_BUMP" ] || [ "$AUTO_BUMP" = "true" ]; then
            echo "Auto-bump enabled. Fetching tags..."
            git fetch --tags --prune

            latest_tag=$(git tag -l 'v5.*' --sort=-v:refname | head -n1 || true)
            if [ -z "$latest_tag" ]; then
              next_tag="v5.3"
            else
              minor=$(echo "$latest_tag" | sed -E 's/^v5\.([0-9]+).*$/\1/')
              if ! echo "$minor" | grep -Eq '^[0-9]+$'; then
                minor=2
              fi
              next_minor=$((minor + 1))
              next_tag="v5.${next_minor}"
              # ensure uniqueness
              while git rev-parse --verify --quiet "$next_tag" >/dev/null; do
                next_minor=$((next_minor + 1))
                next_tag="v5.${next_minor}"
              done
            fi

            echo "Computed next tag: $next_tag"

            # Push tag using GITHUB_TOKEN
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
            git tag -a "$next_tag" -m "Release $next_tag"
            git push origin "$next_tag"

            echo "tag=$next_tag" >> $GITHUB_OUTPUT
            exit 0
          fi

          # If auto_bump is false, expect a manual tag input
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            echo "Using manual tag: ${{ github.event.inputs.tag }}"
            echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Error: auto_bump is false but no manual 'tag' input provided" >&2
          exit 1

      - name: Create zip of EFI
        run: |
          mkdir -p release
          zip -r release/efi-${{ steps.set_tag.outputs.tag }}.zip macos\* efi || zip -r release/efi-${{ steps.set_tag.outputs.tag }}.zip efi || true

      - name: Generate SHA256
        run: |
          ls -la release
          sha256sum release/* > release/SHA256SUMS.txt || shasum -a 256 release/* > release/SHA256SUMS.txt

      - name: Generate release notes
        id: notes
        env:
          REPO: ${{ github.repository }}
          NEW_TAG: ${{ steps.set_tag.outputs.tag }}
        run: |
          set -eux
          git fetch --tags --prune || true

          # find previous v5.* tag (exclude the new tag)
          prev_tag=$(git tag -l 'v5.*' --sort=-v:refname | grep -v "^${NEW_TAG}$" | head -n1 || true)
          echo "prev_tag=${prev_tag:-}" >&2

          if [ -z "$prev_tag" ]; then
            echo "No previous v5.* tag found; collecting commits up to ${NEW_TAG}"
            commits=$(git log --pretty=format:'%h|%s|%H' ${NEW_TAG} -n 200)
          else
            commits=$(git log --pretty=format:'%h|%s|%H' ${prev_tag}..${NEW_TAG})
          fi

          fixes=""
          optim=""
          others=""

          while IFS='|' read -r short subject full; do
            if echo "$subject" | grep -iE 'fix|fixes|bug|bugfix' >/dev/null; then
              fixes+="- ${subject} ([${short}](https://github.com/${REPO}/commit/${full}))\n"
            elif echo "$subject" | grep -iE 'perf|optim|optimi|refactor' >/dev/null; then
              optim+="- ${subject} ([${short}](https://github.com/${REPO}/commit/${full}))\n"
            else
              others+="- ${subject} ([${short}](https://github.com/${REPO}/commit/${full}))\n"
            fi
          done <<EOF
$commits
EOF

          # detect affected platforms by changed files
          changed_files=$( [ -n "$prev_tag" ] && git diff --name-only ${prev_tag}..${NEW_TAG} || git diff --name-only ${NEW_TAG}^! )
          platforms="None detected"
          if echo "$changed_files" | grep -i 'macos monterey' >/dev/null || echo "$changed_files" | grep -i 'macos Monterey' >/dev/null; then
            platforms="Monterey"
          fi
          if echo "$changed_files" | grep -i 'macos sonoma' >/dev/null || echo "$changed_files" | grep -i 'macOS Sonoma' >/dev/null; then
            if [ "$platforms" = "None detected" ]; then
              platforms="Sonoma"
            else
              platforms="${platforms}, Sonoma"
            fi
          fi

          compare_url="https://github.com/${REPO}/compare"
          if [ -n "$prev_tag" ]; then
            compare_url="https://github.com/${REPO}/compare/${prev_tag}...${NEW_TAG}"
          fi

          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "# Release ${NEW_TAG}" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "## Summary" >> $GITHUB_OUTPUT
          echo "- Tag: ${NEW_TAG}" >> $GITHUB_OUTPUT
          echo "- Platforms affected: ${platforms}" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          if [ -n "$prev_tag" ]; then
            echo "## Compare" >> $GITHUB_OUTPUT
            echo "${compare_url}" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
          fi

          if [ -n "$fixes" ]; then
            echo "## Fixed" >> $GITHUB_OUTPUT
            printf "%b" "$fixes" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
          fi

          if [ -n "$optim" ]; then
            echo "## Optimized" >> $GITHUB_OUTPUT
            printf "%b" "$optim" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
          fi

          if [ -n "$others" ]; then
            echo "## Changes" >> $GITHUB_OUTPUT
            printf "%b" "$others" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
          fi

          echo "*Generated by GitHub Actions*" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          tag_name: ${{ steps.set_tag.outputs.tag }}
          body: ${{ steps.notes.outputs.body }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}