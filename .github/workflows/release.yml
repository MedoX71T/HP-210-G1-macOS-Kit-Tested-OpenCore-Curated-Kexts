name: Build Release Asset & Checksums

permissions:
  contents: write

concurrency:
  group: release
  cancel-in-progress: false

on:
  workflow_dispatch:
    inputs:
      auto_bump:
        description: 'Automatically bump minor version (v5.x â†’ v5.(x+1)).'
        required: false
        default: 'true'
      tag:
        description: 'Tag name for release (e.g., v5.4). If auto_bump=true this is ignored.'
        required: false
  release:
    types: [created]

jobs:
  package:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine tag
        id: set_tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [ "${GITHUB_EVENT_NAME}" = "release" ]; then
            echo "Using tag from release event: ${{ github.event.release.tag_name }}"
            echo "tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
            exit 0
          fi

          AUTO_BUMP="${{ github.event.inputs.auto_bump }}"
          if [ -z "$AUTO_BUMP" ] || [ "$AUTO_BUMP" = "true" ]; then
            echo "Auto-bump enabled. Fetching tags..."
            git fetch --tags --prune

            latest_tag=$(git tag -l 'v5.*' --sort=-v:refname | head -n1 || true)
            if [ -z "$latest_tag" ]; then
              next_minor=3
            else
              minor=$(echo "$latest_tag" | sed -E 's/^v5\.([0-9]+).*$/\1/')
              if ! echo "$minor" | grep -Eq '^[0-9]+$'; then
                minor=2
              fi
              next_minor=$((minor + 1))
            fi

            max_attempts=3
            attempt=1
            while [ $attempt -le $max_attempts ]; do
              next_tag="v5.${next_minor}"
              # ensure unique locally
              while git rev-parse --verify --quiet "$next_tag" >/dev/null; do
                next_minor=$((next_minor + 1))
                next_tag="v5.${next_minor}"
              done

              echo "Attempting to create and push tag: $next_tag (attempt $attempt/$max_attempts)"
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"
              git tag -a "$next_tag" -m "Release $next_tag" || (git tag -d "$next_tag" >/dev/null 2>&1 || true)

              # push using token in URL; avoid exposing token in logs by not enabling xtrace
              if git push "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" "refs/tags/$next_tag"; then
                echo "Pushed tag $next_tag"
                echo "tag=$next_tag" >> $GITHUB_OUTPUT
                break
              else
                echo "Push failed for tag $next_tag; fetching tags and retrying"
                git fetch --tags --prune
                if git rev-parse --verify --quiet "$next_tag" >/dev/null; then
                  echo "Tag $next_tag exists remotely, incrementing"
                  next_minor=$((next_minor + 1))
                fi
                git tag -d "$next_tag" >/dev/null 2>&1 || true
                attempt=$((attempt + 1))
                sleep 2
              fi
            done

            if [ $attempt -gt $max_attempts ]; then
              echo "Failed to push tag after $max_attempts attempts" >&2
              exit 1
            fi

            exit 0
          fi

          # If auto_bump is false, expect a manual tag input
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            echo "Using manual tag: ${{ github.event.inputs.tag }}"
            echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Error: auto_bump is false but no manual 'tag' input provided" >&2
          exit 1

      - name: Create zip of EFI
        run: |
          mkdir -p release
          zip -r release/efi-${{ steps.set_tag.outputs.tag }}.zip macos\* efi || zip -r release/efi-${{ steps.set_tag.outputs.tag }}.zip efi || true

      - name: Generate SHA256
        run: |
          ls -la release
          sha256sum release/* > release/SHA256SUMS.txt || shasum -a 256 release/* > release/SHA256SUMS.txt

      - name: Generate release notes
        id: notes
        env:
          REPO: ${{ github.repository }}
          NEW_TAG: ${{ steps.set_tag.outputs.tag }}
        run: |
          set -euo pipefail
          git fetch --tags --prune || true

          # find previous v5.* tag (exclude the new tag)
          prev_tag=$(git tag -l 'v5.*' --sort=-v:refname | grep -v "^${NEW_TAG}$" | head -n1 || true)
          echo "prev_tag=${prev_tag:-}" >&2

          if [ -z "$prev_tag" ]; then
            echo "No previous v5.* tag found; collecting commits up to ${NEW_TAG}"
            commits=$(git log --pretty=format:'%h|%s|%H' ${NEW_TAG} -n 200 || true)
          else
            commits=$(git log --pretty=format:'%h|%s|%H' ${prev_tag}..${NEW_TAG} || true)
          fi

          fixes=""
          optim=""
          others=""

          while IFS='|' read -r short subject full; do
            if echo "$subject" | grep -iE 'fix|fixes|bug|bugfix' >/dev/null; then
              fixes+="- ${subject} ([${short}](https://github.com/${REPO}/commit/${full}))\n"
            elif echo "$subject" | grep -iE 'perf|optim|optimi|refactor' >/dev/null; then
              optim+="- ${subject} ([${short}](https://github.com/${REPO}/commit/${full}))\n"
            else
              others+="- ${subject} ([${short}](https://github.com/${REPO}/commit/${full}))\n"
            fi
          done <<EOF
$commits
EOF

          # detect affected platforms by changed files
          if [ -n "$prev_tag" ]; then
            changed_files=$(git diff --name-only "${prev_tag}..${NEW_TAG}" || true)
          else
            changed_files=$(git diff-tree --no-commit-id --name-only -r "${NEW_TAG}" || true)
          fi

          platforms="None detected"
          if echo "$changed_files" | grep -i 'monterey' >/dev/null; then
            platforms="Monterey"
          fi
          if echo "$changed_files" | grep -i 'sonoma' >/dev/null; then
            if [ "$platforms" = "None detected" ]; then
              platforms="Sonoma"
            else
              platforms="${platforms}, Sonoma"
            fi
          fi

          compare_url="https://github.com/${REPO}/compare"
          if [ -n "$prev_tag" ]; then
            compare_url="https://github.com/${REPO}/compare/${prev_tag}...${NEW_TAG}"
          fi

          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "# Release ${NEW_TAG}" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "## Summary" >> $GITHUB_OUTPUT
          echo "- Tag: ${NEW_TAG}" >> $GITHUB_OUTPUT
          echo "- Platforms affected: ${platforms}" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          if [ -n "$prev_tag" ]; then
            echo "## Compare" >> $GITHUB_OUTPUT
            echo "${compare_url}" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
          fi

          if [ -n "$fixes" ]; then
            echo "## Fixed" >> $GITHUB_OUTPUT
            printf "%b" "$fixes" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
          fi

          if [ -n "$optim" ]; then
            echo "## Optimized" >> $GITHUB_OUTPUT
            printf "%b" "$optim" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
          fi

          if [ -n "$others" ]; then
            echo "## Changes" >> $GITHUB_OUTPUT
            printf "%b" "$others" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
          fi

          echo "*Generated by GitHub Actions*" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          tag_name: ${{ steps.set_tag.outputs.tag }}
          body: ${{ steps.notes.outputs.body }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}